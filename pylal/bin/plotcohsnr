#!/usr/bin/python
"""
Generate various plots related to multi inspiral tables 

Example:
you can use a cache file that will be parsed INSPIRAL files 

>>>  plotcohsnr --enable-output --cache-file
>>> ../playground/inspiral_hipe_playground_intermediate_data-847555570-849974770.cache
>>>   --ifo-times H1H2L1 --user-tag test --verbose

or with a glob option

>>> plotcohsnr --enable-output --inspiral-glob '*COHERENT-* *COHERENT_SLIDE-* '
>>> --ifo-times H1H2L1 --user-tag test --verbose

"""



__version__ = "$Revision$"
__date__ = "$Date$"
__name__ = "plotcohsnr"
__Id__ = "$Id$"
__title__ = "Coherent Inspiral Plots"

# $Source$

import sys
import os
from optparse import *
import re
import exceptions
import glob
from types import *

from pylal import MultiInspiralUtils
from glue import lal
from glue.ligolw import lsctables
from glue import segments
from glue import segmentsUtils
from pylal import InspiralUtils


#################################################################
# help message
usage = """\
%prog [options]
------------------------------------------------------------------------------
  Coherent Inspiral Plotting Functions
  
  The function reads in triggers from a glob of files and produces several 
  different figures.

  The plots are

  1)  SNR v time
  2)  NULL v SNR
  3)  Cumulative Histogram of SNR values
  4)  Histogram of SNR values
"""

#################################################################
def parse_command_line():
  """
  Parser function dedicated
  """
  parser = OptionParser( usage=usage, \
      version= "%prog CVS\n" +
      "$Id$\n" +
      "$Name$\n")

  # histogram related or SNR related
  parser.add_option("-e","--null-snr",action="store_true",default=False,
      help="make a plot of null vs snr" )
  parser.add_option("-E","--snr-time",action="store_true",default=False,
      help="make a plot of snr vs time" )
  parser.add_option("-f","--cum-hist-snr",action="store_true",default=False,
      help="cumulative histogram of the snr" )
  parser.add_option("-F","--hist-snr",action="store_true",default=False,
      help="histogram of the snr" )

  #axis and plotting related
  parser.add_option("", "--add-zero-lag", action="store_true", default=False,
      help="add zero-lag triggers to the histogram and --null-snr plots")
  parser.add_option("-G","--add-vertical-line",action="store",default=None,
      metavar=" GPS_TIME",type="float",
      help="add a vertical line at GPS_TIME to the snr vs time plot" )
  parser.add_option("", "--log", action="store_true", default=False,
      help="set axis to have a log scale")
  parser.add_option("", "--threshold", type="float", default=0,
      help="set the SNR threshold used in the analysis")
  parser.add_option("-n","--nbins",action="store",type="int",default=20,
      metavar=" NBINS", help="number of bins for the histogram plots" )
  parser.add_option("-N","--num-slides",action="store",type="int",default=0,\
      metavar=" NUM_SLIDES",help="number of time slides performed" )
  parser.add_option("-t","--title",action="store",type="string",default=None,
      metavar=" STRING",help="title string for plots")
  parser.add_option("","--min-snr",action="store",type="float",
      default=None, metavar="MIN",help="set plot snr axis min to MIN")
  parser.add_option("","--max-snr",action="store",type="float",
      default=None, metavar="MAX",help="set plot snr axis max to MAX")
  parser.add_option("","--min-null",action="store",type="float",
      default=None, metavar="MIN",help="set plot null axis min to MIN")
  parser.add_option("","--max-null",action="store",type="float",
      default=None, metavar="MAX",help="set plot null axis max to MAX")
  parser.add_option("","--min-time",action="store",type="float",
      default=None, metavar="MIN",help="set plot time axis min to MIN")
  parser.add_option("","--max-time",action="store",type="float",
      default=None, metavar="MAX",help="set plot time axis max to MAX")

  # post analysis 
  parser.add_option("-J","--veto-file",action="store",type="string",
      default=None,metavar=" FNAME",
      help="read in segments from FNAME (assumed segwizard format)")

  #others
  parser.add_option("-s","--show-plot",action="store_true",default=False,
      help="display the figures on the terminal" )
  parser.add_option("-v","--verbose",action="store_true",
      default=False,help="print information" )
  
  # output related
  parser.add_option("-o","--output-path",action="store",
      type="string",default="",  metavar="PATH",
      help="path where the figures would be stored")
  parser.add_option("-O","--enable-output",action="store_true",
      default="false",  metavar="OUTPUT",
      help="enable the generation of the html and cache documents")
  parser.add_option("","--gps-start-time",action="store",
      type="int",  metavar="GPSSTARTTIME",
      help="gps start time (for naming figure and output files")
  parser.add_option("","--gps-end-time",action="store",
      type="int",  metavar=" GPSENDTIME",
      help="gps end time (for naming figure and output files")
  parser.add_option("", "--ifo-tag", help="ifotag for naming output")
  parser.add_option("", "--user-tag", help="usertag for naming output")
  parser.add_option("", "--figure-resolution",action="store",type="int",
      default=50, metavar="resolution of the thumbnails (50 by default)", 
      help="read a file of a particular description  from cache file" )

  #input
  parser.add_option("-U","--glob",action="store",type="string",
      default=None, metavar=" GLOB",
      help="GLOB of coherent inspiral trigger files to read" )
  parser.add_option("-w", "--cache-file",
    help="read trigger filenames from cache file")
  parser.add_option("", "--trig-pattern", metavar="PAT",
    help="sieve trigger files of containing PAT from cache file" )
  parser.add_option("", "--slide-pattern", metavar="PAT",
    help="sieve slide files of containing PAT from cache file" )
  parser.add_option("-i", "--ifo-times",
    help="sieve a cache file according to a particular ifo type")
  parser.add_option("-M","--missed-inj",action="store",type="string",\
      default=None, metavar=" FILE",help="missed injection file")
  parser.add_option("", "--html-for-cbcweb",action="store",\
      default=False, metavar = "CVS DIRECTORY", help="publish the html "\
      "output in a format that can be directly published on the cbc webpage "\
      "or in CVS. This only works IF --enable-output is also specified. The "\
      "argument should be the cvs directory where the html file will be placed "\
      "Example: --html-for-cbcweb protected/projects/s5/yourprojectdir")


  (options,args) = parser.parse_args()

  # test the input options
  if not options.ifo_times: 
    raise ValueError, "--ifo-times must be provided in (H1, H2, L1, V1, G1)"

  if options.cache_file and (options.glob):
    raise ValueError, """
Use either the glob options(--glob)
OR the cachefile options (--cache-file), not both at the same time.
"""

  return options, sys.argv[1:]


# ============================================================================
# -- get command line arguments
opts, args = parse_command_line()
InspiralUtils.message(opts, "reading data...")
# ============================================================================
# Initialise
opts = InspiralUtils.initialise(opts, __name__, __version__)
# -- set the proper color code
colors = InspiralUtils.colors
figure_number = 0  # used for the figure label (showplot)
fnameList = []   # use for the cache file
tagList= []   # use for the cache file

# to avoid  display problem when show plot is not used
if not opts.show_plot:
  import matplotlib
  matplotlib.use('Agg')
from pylab import *
from pylal import viz

# check at least one trig file was specified
if opts.glob is None and opts.cache_file is None:
  print >>sys.stderr, "Must specify a GLOB of files to read or a LAL cache"
  print >>sys.stderr, "Enter 'plotcohsnr --help' for usage"
  sys.exit(1)

# load cache
if opts.cache_file is not None:
  cache = lal.Cache.fromfile(open(opts.cache_file))
  if opts.ifo_times:
    cache = cache.sieve(ifos=opts.ifo_times, exact_match=True)

# determine trigger files
trigFiles = []
slideFiles = []
if opts.glob is not None:
  allFiles = []
  for gl in opts.glob.split(" "):
    allFiles.extend(glob.glob(gl))
  for file in allFiles:
    if 'SLIDE' in file:
      slideFiles.append(file)
    else:
      trigFiles.append(file)

if opts.trig_pattern is not None:
  trig_cache = cache.sieve(description=opts.trig_pattern)
  trigFiles.extend(trig_cache.checkfilesexist()[0].pfnlist())

  slide_cache = cache.sieve(description=opts.slide_pattern)
  slideFiles.extend(slide_cache.checkfilesexist()[0].pfnlist())

# check if the file lists are not empty
if not (trigFiles or slideFiles):
  print >>sys.stdout, "The trigger files or slide files lists are empty."
  sys.exit(1)

  print >>sys.stderr, "There are " + str(len(trigFiles))+" files in your glob and/or lal cache"

tmpTriggers = MultiInspiralUtils.ReadMultiInspiralFromFiles(trigFiles)
inspTriggers = lsctables.table.new_from_template(tmpTriggers)
inspSlide = lsctables.table.new_from_template(tmpTriggers)
for row in tmpTriggers:
  if row.get_slide_number() == 0:
    inspTriggers.append(row)
  else:
    inspSlide.append(row)

slideTriggers = []
if opts.num_slides:
  #inspSlide = MultiInspiralUtils.ReadMultiInspiralFromFiles(slideFiles)

  # perform the veto
  if opts.veto_file:
    seglist = segmentsUtils.fromsegwizard(open(opts.veto_file, "r"))
    inspSlide = inspSlide.veto(seglist)

  slide_num = range(1 , opts.num_slides + 1)
  slide_num.extend(range(-opts.num_slides, 0))

  for slide in slide_num:
    this_slide = {}
    this_slide["slide_num"] = slide
    this_slide["coinc_trigs"] = inspSlide.getslide(slide)
    slideTriggers.append(this_slide)

# apply veto if there is one
if opts.veto_file:
  seglist = segmentsUtils.fromsegwizard(open(opts.veto_file))
  inspTriggers = inspTriggers.veto(seglist)
  for slide in slideTriggers:
    slide = slide.veto(seglist)

max_snr = max(inspTriggers.get_column('snr'))
min_snr = min(inspTriggers.get_column('snr'))
snr_range = arange( min_snr, max_snr, (max_snr - min_snr)/100  )

###################################
# plot of snr vs time
if opts.snr_time is True:
  text = "SNR versus end time"
  InspiralUtils.message(opts, "plotting..."+text)
  figure_number += 1
  figure(figure_number)
  if opts.log:
    ax = subplot(111)
    ax.set_yscale('log')
  if opts.add_vertical_line:
    axvline(opts.add_vertical_line - int(opts.add_vertical_line),
        linewidth=1, color='r')  
    for idx in range(len(inspTriggers)):
      inspTriggers[idx].end_time = inspTriggers[idx].end_time \
          - int(opts.add_vertical_line)
    viz.plot_a_v_b(inspTriggers,'end_time','snr','seconds','kx',
        x_min=opts.min_time, x_max=opts.max_time, y_min=opts.min_snr,
        y_max=opts.max_snr)
  else:
    viz.plot_a_v_b(inspTriggers,'end_time','snr','linear','kx',
        y_min=opts.min_snr, y_max=opts.max_snr)
  if opts.enable_output is True:
    fname = InspiralUtils.set_figure_name(opts, "snr_vs_time")
    fname_thumb = InspiralUtils.savefig_pylal(filename=fname, doThumb=True,
        dpi_thumb=opts.figure_resolution)
    fnameList.append(fname)
    tagList.append(text)
  if not opts.show_plot:
    close()


###################################
# plot of null vs snr
if opts.null_snr is True:
  text = "Null Statistic versus Coherent SNR"
  InspiralUtils.message(opts, "plotting..."+text)
  figure_number += 1
  figure(figure_number)
  if opts.log:
    ax = subplot(111)
    ax.set_xscale('log')
    ax.set_yscale('log')
  for slide in slideTriggers:
    viz.plot_a_v_b(slide["coinc_trigs"],'snr','null_statistic','linear','kx',
        x_min=opts.min_snr, x_max=opts.max_snr, y_min=opts.min_null,
        y_max=opts.max_null)
  if opts.add_zero_lag:
    hold(True)
    viz.plot_a_v_b(inspTriggers,'snr','null_statistic','linear','bx',
        x_min=opts.min_snr, x_max=opts.max_snr, y_min=opts.min_null,
        y_max=opts.max_null)
  if opts.enable_output is True: 
    fname = InspiralUtils.set_figure_name(opts, "null_vs_snr")
    fname_thumb = InspiralUtils.savefig_pylal(filename=fname, doThumb=True,
        dpi_thumb=opts.figure_resolution)
    fnameList.append(fname)
    tagList.append(text)
  if not opts.show_plot:
    close()


###################################
# cumulative histogram of snr
if opts.cum_hist_snr is True:
  text = "SNR,cumulative histogram"
  InspiralUtils.message(opts, "plotting..."+text)
  figure_number += 1
  figure(figure_number)
  xlimits = [0,0]
  if opts.min_snr and opts.max_snr:
    xlimits = [opts.min_snr, opts.max_snr]
  if opts.threshold>0:
    xlimits[0] = opts.threshold

  viz.cumhiststat(trigs=inspTriggers, slide_trigs=slideTriggers,
      stat='coherent_snr', min_val=xlimits[0], max_val=xlimits[1],
      nbins=opts.nbins)
  
  if opts.enable_output is True: 
    fname = InspiralUtils.set_figure_name(opts, "snr_cum_hist")
    fname_thumb = InspiralUtils.savefig_pylal(filename=fname, doThumb=True,
        dpi_thumb=opts.figure_resolution)
    fnameList.append(fname)
    tagList.append(text)
  if not opts.show_plot:
    close()


###################################
# histogram of snr
if opts.hist_snr is True:
  text = "SNR histogram"
  InspiralUtils.message(opts, "plotting..."+text)
  figure_number += 1
  figure(figure_number)
  xlimits = [0,0]
  if opts.min_snr and opts.max_snr:
    xlimits = [opts.min_snr, opts.max_snr]
  if opts.threshold>0:
    xlimits = [opts.threshold, 0]

  viz.histstat(trigs=inspTriggers, slide_trigs=slideTriggers,
      min_val=opts.min_snr, max_val=opts.max_snr, nbins=opts.nbins,
      stat='coherent_snr')

  if opts.enable_output is True: 
    fname = InspiralUtils.set_figure_name(opts, "snr_histogram")
    fname_thumb = InspiralUtils.savefig_pylal(filename=fname, doThumb=True,
        dpi_thumb=opts.figure_resolution)
    fnameList.append(fname)
    tagList.append(text)
  if not opts.show_plot:
    close()


#########################################
# final step: html, cache file generation
if opts.enable_output is True:
  html_filename = InspiralUtils.write_html_output(opts, args, fnameList,
      tagList)
  InspiralUtils.write_cache_output(opts, html_filename, fnameList)
  if opts.html_for_cbcweb:
    html_filename_publish = InspiralUtils.write_html_output(opts, args, fnameList, tagList, cbcweb=True)

if opts.show_plot:
  show()
